<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GoogleWhere - Guess the Populated City</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.ably.io/lib/ably.min-1.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; }
    header { background: #0066cc; color: white; padding: 1rem; text-align: center; }
    #result { text-align: center; background: #fff4cc; padding: 0.75rem; font-weight: bold; }
    #controls {
      padding: 1rem;
      background: #f4f4f4;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      justify-content: center;
    }
    #main-content { flex: 1; display: flex; flex-direction: column; padding: 0.5rem; gap: 0.5rem; height: 100%; }
    #maps { flex: 1; display: flex; flex-direction: column; gap: 0.5rem; }
    #photo-map, #map {
      flex: 1;
      height: 50%;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    #leaderboard {
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 1rem;
      width: 280px;
      overflow-y: auto;
      color: #222;
    }
    #leaderboard h3 {
      margin-top: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #004a99;
      text-align: center;
      text-shadow: 0 1px 1px rgba(0,0,0,0.1);
    }
    #leaderboard-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    #leaderboard-list li {
      padding: 0.3rem 0.5rem;
      border-bottom: 1px solid #ddd;
      transition: background-color 0.3s ease;
    }
    #leaderboard-list li:hover {
      background-color: #d0e7ff;
      color: #003366;
      font-weight: bold;
    }
    #guess-info { text-align: center; padding: 0.5rem; }

    @media (min-width: 768px) {
      #main-content { flex-direction: row; gap: 1rem; }
      #maps { flex: 1; flex-direction: column; height: 100%; }
    }

    @media (max-width: 767px) {
      #leaderboard { width: 100%; height: 150px; order: 2; }
      #maps { order: 1; }
    }
  </style>
</head>
<body>
<header>GoogleWhere - Guess the Populated City</header>
<div id="result"></div>
<div id="controls">
  <input type="text" id="playerName" placeholder="Your name" />
  <button id="submit-btn" disabled>Submit</button>
  <button id="next-btn" style="display:none;">Next</button>
</div>
<div id="main-content">
  <div id="maps">
    <div id="photo-map"></div>
    <div id="map"></div>
  </div>
  <div id="leaderboard">
    <h3>Leaderboard</h3>
    <ul id="leaderboard-list"></ul>
  </div>
</div>
<div id="guess-info">Tap the map to guess the location!</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const locations = [
    {"lat":40.7,"lng":-73.9},{"lat":34.1,"lng":-118.2},{"lat":48.8,"lng":2.3},
    {"lat":35.6,"lng":139.7},{"lat":51.5,"lng":-0.1},{"lat":19.4,"lng":-99.1},
    {"lat":55.8,"lng":37.6},{"lat":-33.9,"lng":151.2},{"lat":1.3,"lng":103.8},
    {"lat":52.5,"lng":13.4}
  ];

  let locationQueue = [];
  let selected = null;
  let guessLocation = null;
  let photoMap, mainMap, photoMarker, markerLayer;
  let leaderboard = [];

  const ably = new Ably.Realtime('0nCEnA.7-aC8g:zCvcQ-hz9TjxNNVCQBM_52vEDQQrC9DbKVNmwwDhjj4');
  const channel = ably.channels.get('googlewhere-leaderboard');

  channel.subscribe('update', (message) => {
    leaderboard = message.data;
    updateLeaderboard();
  });

  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
  }

  function getNextLocation() {
    if (locationQueue.length === 0) {
      locationQueue = [...locations];
      shuffle(locationQueue);
    }
    return locationQueue.pop();
  }

  function toRad(d) { return d * Math.PI / 180; }

  function getDistance(a, b) {
    const R = 6371;
    const dLat = toRad(b.lat - a.lat);
    const dLng = toRad(b.lng - a.lng);
    const aComp = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat)) * Math.cos(toRad(b.lat)) * Math.sin(dLng/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(aComp), Math.sqrt(1 - aComp));
  }

  function updateLeaderboard() {
    const list = document.getElementById("leaderboard-list");
    list.innerHTML = "";
    leaderboard.slice(0, 10).forEach(({name, score}, idx) => {
      const li = document.createElement("li");
      let badge = idx === 0 ? " üèÜ" : idx === 1 ? " ü•à" : idx === 2 ? " ü•â" : "";
      li.textContent = `${idx + 1}. ${name} - ${score} pts${badge}`;
      list.appendChild(li);
    });
  }

  function startGame() {
    selected = getNextLocation();
    guessLocation = null;
    document.getElementById("result").innerText = "";
    document.getElementById("guess-info").innerText = "Tap the map to guess!";
    document.getElementById("submit-btn").disabled = true;
    document.getElementById("next-btn").style.display = "none";

    photoMap.setView([selected.lat, selected.lng], 14);
    if (photoMarker) photoMap.removeLayer(photoMarker);
    photoMarker = L.marker([selected.lat, selected.lng]).addTo(photoMap);

    mainMap.setView([20, 0], 2);
    markerLayer.clearLayers();
    mainMap.on("click", onGuessClick);
  }

  function onGuessClick(e) {
    const name = document.getElementById("playerName").value.trim();
    if (!name) return alert("Please enter your name first.");
    guessLocation = e.latlng;
    markerLayer.clearLayers();
    L.marker(guessLocation).addTo(markerLayer);
    document.getElementById("submit-btn").disabled = false;
  }

  function submitGuess() {
    const name = document.getElementById("playerName").value.trim();
    const dist = getDistance(guessLocation, selected);
    document.getElementById("result").innerHTML = `You were ${dist.toFixed(1)} km from the hidden location`;
    L.marker([selected.lat, selected.lng]).addTo(markerLayer);

    let points = 0;
    if (dist <= 50) points = 50;
    else if (dist <= 500) points = 20;
    else if (dist <= 1000) points = 10;

    let player = leaderboard.find(p => p.name === name);
    if (player) {
      player.score += points;
    } else {
      leaderboard.push({ name, score: points });
    }

    leaderboard.sort((a, b) => b.score - a.score);
    channel.publish('update', leaderboard);
    updateLeaderboard();

    document.getElementById("submit-btn").disabled = true;
    document.getElementById("next-btn").style.display = "inline-block";
    mainMap.off("click");
  }

  window.onload = () => {
    photoMap = L.map("photo-map", {
      zoomControl: false,
      dragging: false,
      scrollWheelZoom: false,
      minZoom: 14,
      maxZoom: 18
    });

    mainMap = L.map("map");
    markerLayer = L.layerGroup().addTo(mainMap);

    const tiles = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
    L.tileLayer(tiles, { maxZoom: 18 }).addTo(photoMap);
    L.tileLayer(tiles, { maxZoom: 18 }).addTo(mainMap);

    fetch('https://rest.ably.io/channels/googlewhere-leaderboard/messages?limit=1&direction=backwards', {
      headers: {
        'Authorization': 'Basic ' + btoa('YOUR-ABLY-REST-KEY')
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.length > 0 && data[0].data) {
        leaderboard = data[0].data;
        updateLeaderboard();
      }
    })
    .catch(console.error);

    document.getElementById("submit-btn").onclick = submitGuess;
    document.getElementById("next-btn").onclick = startGame;

    startGame();
  };
</script>
</body>
</html>
